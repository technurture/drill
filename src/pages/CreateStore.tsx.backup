import { useContext, useState, useEffect, useRef } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { useAuth } from "../contexts/AuthContext";
import { useStores } from "../integrations/supabase/hooks/stores";
import { supabase } from "../integrations/supabase/supabase";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { 
  ArrowLeft, 
  Loader2, 
  Upload,
  X,
  Store,
  MapPin,
  Camera,
  Sparkles,
  Zap,
  Shield,
  BarChart3,
  CheckCircle
} from "lucide-react";
import { setStoreContext } from "@/contexts/StoreContext";
import { SubscriptionContext } from "@/contexts/SubscriptionContext";
import { storeRestriction } from "@/utils/subscriptionHelpers/storeRestriction";
import { useTheme } from "@/contexts/ThemeContext";
import { useReferrals } from "@/hooks/useReferrals";
import toast from "react-hot-toast";
import { useAddFinancialInclusion } from "@/integrations/supabase/hooks/marketers";
import { Select, SelectItem } from "@nextui-org/select";
import { marketers } from "@/utils/data";
import { Cropper, CropperRef, RectangleStencil } from 'react-advanced-cropper';
import 'react-advanced-cropper/dist/style.css';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { getRandomUnsplashImage, preloadImage } from "@/utils/unsplashUtils";

const storeSchema = z.object({
  name: z.string().min(1, "Store name is required"),
  location: z.string().min(1, "Store location is required"),
  referralCode: z.string().optional(),
  storeFootnote: z.string().optional(),
});

const CreateStore = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [isLoading, setLoading] = useState(false);
  const location = useLocation();
  const setStore = useContext(setStoreContext);
  const { data: stores } = useStores(user?.id);
  const subscriptionData = useContext(SubscriptionContext);
  const addToMarketer = useAddFinancialInclusion()
  const { theme } = useTheme();
  const { createReferral } = useReferrals();
  const [hasStore, setHasStore] = useState<boolean>();
  const [avatarUploading, setAvatarUploading] = useState(false);
  const [avatarUrl, setAvatarUrl] = useState("");
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const imgRef = useRef<HTMLImageElement>(null);
  const [cropModalOpen, setCropModalOpen] = useState(false);
  const [imgSrc, setImgSrc] = useState('');
  const [croppedPreviewUrl, setCroppedPreviewUrl] = useState<string>("");
  const [cropperSrc, setCropperSrc] = useState<string>("");
  const [cropperModalOpen, setCropperModalOpen] = useState(false);
  const cropperRef = useRef<CropperRef>(null);
  const [backgroundImage, setBackgroundImage] = useState("");
  const [imageLoaded, setImageLoaded] = useState(false);
  const [selectedOption, setSelectedOption] = useState<string>("");

  // Load random background image
  useEffect(() => {
    const loadBackgroundImage = async () => {
      try {
        const imageUrl = await getRandomUnsplashImage('createStore');
        await preloadImage(imageUrl);
        setBackgroundImage(imageUrl);
        setImageLoaded(true);
      } catch (error) {
        console.error('Failed to load background image:', error);
        setImageLoaded(true); // Still set to true to show fallback
      }
    };

    loadBackgroundImage();
  }, []);

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      setCropperSrc(reader.result as string);
      setCropperModalOpen(true);
    };
    reader.readAsDataURL(file);
  };

  const handleCropUpload = async () => {
    if (!cropperRef.current) return;
    const canvas = cropperRef.current.getCanvas();
    if (!canvas) return;
    canvas.toBlob((blob) => {
      if (!blob) return;
      const croppedFile = new File([blob], `avatar_${Date.now()}.jpg`, { type: 'image/jpeg' });
      setAvatarFile(croppedFile);
      setAvatarUrl(URL.createObjectURL(croppedFile));
      setCroppedPreviewUrl("");
      setCropperModalOpen(false);
    }, 'image/jpeg');
  };

  const handleCropCancel = () => {
    setCropperModalOpen(false);
    setCropperSrc("");
    setCroppedPreviewUrl("");
  };

  const form = useForm({
    resolver: zodResolver(storeSchema),
    defaultValues: {
      name: "",
      location: "",
      referralCode: "",
      storeFootnote: "Thank you for your patronage",
    },
  });

  const { setValue, getValues } = form
  const formValues = getValues()

  const recordMarketerUsers = async() => {
    await addToMarketer.mutateAsync({
      email: user?.email,
      store_name: formValues.name,
      location: formValues.location,
      reward: "0",
      amount_paid: "0",
      payment_status: "passive"
    })
  }
  const updateReferral = async(referral_code) => {
    if(selectedOption === "code") {
      await createReferral.mutateAsync(referral_code);
      const {error: referralCodeError } = await supabase
        .from("users")
        .update({ referred_by: referral_code})
        .eq("id", user?.id)
      if (referralCodeError) throw referralCodeError;
    } else if(selectedOption === "agent") {
      const {data, error: referralCodeError } = await supabase
      .from("users")
      .update({referred_by: referral_code})
      .eq("id", user?.id)
    if (referralCodeError) throw referralCodeError;
    }
  }

  useEffect(() => {
    const checkStore = async () => {
      const { data } = await supabase
        .from("users")
        .select("created_store")
        .eq("id", user?.id);
      if (data[0]?.created_store) {
        setHasStore(true);
      }
    };
    checkStore();
  }, [user, hasStore]);
  useEffect(() => {
      if(selectedOption && selectedOption !== "Referral Code") {
          recordMarketerUsers()
      }
  }, [selectedOption])

  const uploadAvatar = async (file: File): Promise<string | null> => {
    if (!user) return null;
    setAvatarUploading(true);
    
    try {
      const fileName = `${user.id}/${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage
        .from("avatars")
        .upload(fileName, file);

      if (error) throw error;

      const { data: urlData } = supabase.storage
        .from("avatars")
        .getPublicUrl(data.path);

      return urlData.publicUrl;
    } catch (error) {
      console.error("Error uploading avatar:", error);
      toast.error("Failed to upload avatar");
      return null;
    } finally {
      setAvatarUploading(false);
    }
  };

  const onSubmit = async (values: z.infer<typeof storeSchema>) => {
    setLoading(true);
    
    try {
      if (!user) {
        toast.error("User not authenticated");
        return;
      }

       /* commented out subscription checker to make all features free for now */
       
      // if (stores && stores.length > 0) {
      //   const canCreateStore = storeRestriction(
      //     subscriptionData?.userSub?.userSub?.plan_type || "",
      //     stores.length
      //   );
        
      //   if (canCreateStore !== "success") {
      //     toast.error("Upgrade your plan to create more stores");
      //     return;
      //   }
      // }

      let storeAvatarUrl = null;
      if (avatarFile) {
        storeAvatarUrl = await uploadAvatar(avatarFile);
      }

      const { data: storeData, error: storeError } = await supabase
          .from("stores")
        .insert({
          name: values.name,
          location: values.location,
          owner_id: user.id,
          store_avatar: storeAvatarUrl,
          store_footnote: values.storeFootnote || "Thank you for your patronage",
        })
          .select()
          .single();

        if (storeError) throw storeError;

      const { error: userError } = await supabase
          .from("users")
          .update({ created_store: true })
        .eq("id", user.id);

      if (userError) throw userError;

      if (values.referralCode && selectedOption) {
        await updateReferral(values.referralCode);
      }

      setStore.setStore(storeData);
      localStorage.setItem("selectedStoreId", storeData.id);
      toast.success("Store created successfully!");
      navigate("/dashboard");

    } catch (error: any) {
      console.error("Error creating store:", error);
      toast.error(error.message || "Failed to create store");
    } finally {
      setLoading(false);
    }
  };

  const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
  const logoSrc = theme === "dark" 
    ? "/storeer_white.png" 
    : theme === "light" 
    ? "/storeer_black.png" 
    : mediaQuery.matches 
    ? "/storeer_white.png" 
    : "/storeer_black.png";

  const features = [
    {
      icon: Zap,
      title: "Easy Setup",
      description: "Create your store in minutes, not hours"
    },
    {
      icon: BarChart3,
      title: "Track Everything",
      description: "Monitor inventory, sales, and customer data"
    },
    {
      icon: Shield,
      title: "Secure & Reliable",
      description: "Your business data is safe with us"
    }
  ];

  const benefits = [
    "üìä Real-time inventory tracking",
    "üí∞ Sales analytics & reports", 
    "üë• Customer management",
    "üì± Mobile-friendly interface",
    "üîê Secure data storage"
  ];

  return (
    <div className="min-h-screen flex bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-blue-900/20 dark:to-indigo-900/20">
      {/* Left Side - Branding with Unsplash Image */}
      <div className="hidden lg:flex lg:w-1/2 relative overflow-hidden">
        {backgroundImage && imageLoaded && (
          <div 
            className="absolute inset-0 bg-cover bg-center bg-no-repeat transition-opacity duration-1000"
            style={{ backgroundImage: `url(${backgroundImage})` }}
          />
        )}
        <div className="absolute inset-0 bg-black/60"></div>
        
        {/* Content */}
        <div className="relative z-10 flex flex-col justify-center px-12 text-white">
          <div className="mb-8">
            <img
              src="/storeer_white.png"
              alt="Storeer Logo"
              className="w-32 h-auto mb-6"
            />
          </div>
          
          <h1 className="text-4xl font-bold mb-6 leading-tight">
            Create your first
            <span className="block text-blue-200">store today</span>
          </h1>
          
          <p className="text-lg text-blue-100 mb-8 leading-relaxed">
            Set up your store in minutes and start managing your inventory, sales, and customers with our powerful platform.
          </p>

          {/* Features */}
          <div className="space-y-4 mb-8">
            {features.map((feature, index) => {
              const Icon = feature.icon;
              return (
                <div key={index} className="flex items-start space-x-3">
                  <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Icon className="w-4 h-4" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-sm">{feature.title}</h3>
                    <p className="text-sm text-blue-100/80">{feature.description}</p>
                  </div>
                </div>
              );
            })}
          </div>

          {/* Benefits */}
          <div className="bg-white/10 rounded-2xl p-6 backdrop-blur-sm">
            <h3 className="font-semibold text-lg mb-4">What you'll get:</h3>
            <div className="space-y-2">
              {benefits.map((benefit, index) => (
                <div key={index} className="flex items-center space-x-3">
                  <CheckCircle className="w-4 h-4 text-blue-200 flex-shrink-0" />
                  <span className="text-sm text-blue-100">{benefit}</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Decorative Elements */}
        <div className="absolute top-20 right-20 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>
        <div className="absolute bottom-20 left-20 w-24 h-24 bg-purple-300/20 rounded-full blur-lg"></div>
      </div>

      {/* Right Side - Create Store Form */}
      <div className="flex-1 flex items-center justify-center p-6 lg:p-12">
        <div className="w-full max-w-md">
          {/* Mobile Logo */}
          <div className="lg:hidden flex justify-center mb-8">
            <img
              src={logoSrc}
              alt="Storeer Logo"
              className="w-24 h-auto"
            />
          </div>

          {/* Back Button */}
          <div className="flex items-center mb-6">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => navigate(-1)}
              className="mr-2 -ml-2"
            >
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back
            </Button>
          </div>

          <Card className="border-0 shadow-2xl bg-white/80 dark:bg-gray-900/80 backdrop-blur">
            <CardHeader className="text-center space-y-2">
              <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mx-auto mb-2">
                <Store className="w-6 h-6 text-white" />
              </div>
              <CardTitle className="text-2xl font-bold text-gray-900 dark:text-white">
                {stores && stores.length === 0 ? "Create Your First Store" : "Create a New Store"}
              </CardTitle>
              <CardDescription className="text-gray-600 dark:text-gray-400">
                {stores && stores.length === 0 ? "Get started by setting up your first business store" : "Add another store to your business portfolio"}
              </CardDescription>
            </CardHeader>

            <CardContent className="space-y-6">
              {/* Store Avatar Upload */}
              <div className="text-center">
                <div className="relative inline-block">
                  <div className="w-20 h-20 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center overflow-hidden border-4 border-white dark:border-gray-800 shadow-lg">
                    {avatarUrl ? (
                      <img src={avatarUrl} alt="Store Avatar" className="w-full h-full object-cover" />
                    ) : (
                      <Store className="w-8 h-8 text-gray-400" />
                    )}
                  </div>
                  <button
                    type="button"
                    onClick={() => fileInputRef.current?.click()}
                    className="absolute -bottom-1 -right-1 w-7 h-7 bg-blue-600 hover:bg-blue-700 rounded-full flex items-center justify-center text-white shadow-lg transition-colors"
                    disabled={avatarUploading}
                  >
                    <Camera className="w-3 h-3" />
                  </button>
                </div>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  {avatarUploading ? "Uploading..." : "Upload store logo"}
                </p>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleAvatarChange}
                  className="hidden"
                />
          </div>

              {/* Form */}
          <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                        <FormLabel className="text-gray-700 dark:text-gray-300">Store Name</FormLabel>
                    <FormControl>
                          <div className="relative">
                            <Store className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                      <Input
                        {...field}
                              placeholder="e.g. John's Electronics"
                              className="pl-10 h-11 border-gray-200 dark:border-gray-700 focus:border-blue-500 dark:focus:border-blue-400"
                      />
                          </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="location"
                render={({ field }) => (
                  <FormItem>
                        <FormLabel className="text-gray-700 dark:text-gray-300">Store Location</FormLabel>
                        <FormControl>
                          <div className="relative">
                            <MapPin className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                            <Input
                              {...field}
                              placeholder="e.g. Lagos, Nigeria"
                              className="pl-10 h-11 border-gray-200 dark:border-gray-700 focus:border-blue-500 dark:focus:border-blue-400"
                            />
                          </div>
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="storeFootnote"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel className="text-gray-700 dark:text-gray-300">Receipt Message (Optional)</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                            placeholder="Thank you for your patronage"
                            className="h-11 border-gray-200 dark:border-gray-700 focus:border-blue-500 dark:focus:border-blue-400"
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

               {user && !hasStore && (
                        <FormItem>
                      <FormLabel className="text-gray-700 dark:text-gray-300">Referred By (Optional)</FormLabel>
                          <FormControl>
                            <Select
                              aria-labelledby="Select Referral Method"
                          placeholder="Select how you heard about us"
                              className="w-full"
                              value={selectedOption}
                              onSelectionChange={(selectedOption) =>
                                setSelectedOption(selectedOption.currentKey)
                              }
                              classNames={{
                            trigger: "!h-11 !px-4 !flex !items-center !justify-between !rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-transparent bg-white focus:border-blue-500 dark:focus:border-blue-400",
                            value: "!text-sm !text-gray-900 dark:!text-white",
                            selectorIcon: "stroke-gray-400 size-5",
                            listbox: "bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-2",
                              }}       
                            >
                        {marketers.map((marketer) => (
                          <SelectItem key={marketer} value={marketer}>{marketer}</SelectItem>
                        ))}
                            </Select>
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                )}

                  {selectedOption === "code" && (
                <FormField
                control={form.control}
                name="referralCode"
                render={({ field }) => (
                  <FormItem>
                          <FormLabel className="text-gray-700 dark:text-gray-300">Referral Code</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                        placeholder="Enter referral code"
                              className="h-11 border-gray-200 dark:border-gray-700 focus:border-blue-500 dark:focus:border-blue-400"
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
                )}

                  <Button 
                    type="submit" 
                    className="w-full h-11 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium transition-all duration-200 shadow-lg hover:shadow-xl"
                    disabled={isLoading}
                  >
                    {isLoading ? (
                      <>
                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                        Creating Store...
                      </>
                    ) : (
                      <>
                        <Store className="w-4 h-4 mr-2" />
                        Create Store
                      </>
                    )}
                </Button>
            </form>
          </Form>
        </CardContent>
      </Card>

          {/* Success Message */}
          <div className="mt-6 text-center">
            <p className="text-sm text-gray-600 dark:text-gray-400">
              üéâ Ready to start your business journey with Storeer!
            </p>
          </div>
        </div>
      </div>

      {/* Crop Modal */}
      <Dialog open={cropperModalOpen} onOpenChange={setCropperModalOpen}>
        <DialogContent className="max-w-[90vw] sm:max-w-[600px]">
          <DialogHeader>
            <DialogTitle>Crop Store Logo</DialogTitle>
          </DialogHeader>
          {cropperSrc && (
            <div className="relative max-h-[70vh] overflow-auto">
              <Cropper
                ref={cropperRef}
                src={cropperSrc}
                stencilComponent={RectangleStencil}
                className="w-full h-[350px]"
              />
            </div>
          )}
          <div className="flex justify-end gap-2 mt-4">
            <Button variant="outline" onClick={handleCropCancel} disabled={avatarUploading}>
              Cancel
            </Button>
            <Button onClick={handleCropUpload} disabled={avatarUploading}>
              {avatarUploading ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Uploading...
                </>
              ) : (
                'Apply Crop'
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default CreateStore;
